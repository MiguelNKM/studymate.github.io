<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyMate 2.4 - Your Personal Study Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.7.570/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.5.2/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<!-- Include the latest Math.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.0.1/math.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/algebra.js/0.2.6/algebra.min.js"></script>
    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_aW1tb3J0YWwtZXNjYXJnb3QtMTkuY2xlcmsuYWNjb3VudHMuZGV2JA"
      src="https://immortal-escargot-19.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
      type="text/javascript"
    ></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f39c12;
            --background-color: #f4f4f4;
            --text-color: #333;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: var(--primary-color);
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidebar a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #fff;
            display: block;
            transition: 0.3s;
        }

        .sidebar a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        .openbtn {
            font-size: 20px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
        }

        .openbtn:hover {
            background-color: #444;
        }

        #main {
            transition: margin-left .5s;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .tab-content.active {
            display: block;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3a7bc8;
        }

        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            padding: 3px;
            border-radius: 3px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2);
            margin-bottom: 20px;
        }

        .progress-bar-fill {
            display: block;
            height: 22px;
            background-color: var(--primary-color);
            border-radius: 3px;
            transition: width 500ms ease-in-out;
        }

        .dark-mode {
            --background-color: #333;
            --text-color: #f4f4f4;
        }

        .dark-mode .header, .dark-mode .tab-content {
            background-color: #444;
            color: #f4f4f4;
        }

        .flashcard {
            width: 300px;
            height: 200px;
            perspective: 1000px;
            margin: 20px auto;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .flashcard-front {
            background-color: #f8f8f8;
            color: #333;
        }

        .flashcard-back {
            background-color: var(--primary-color);
            color: white;
            transform: rotateY(180deg);
        }

        #pomodoro {
            text-align: center;
            margin-top: 20px;
        }

        #timer {
            font-size: 48px;
            margin-bottom: 20px;
        }

        @media screen and (max-height: 450px) {
            .sidebar {padding-top: 15px;}
            .sidebar a {font-size: 18px;}
        }

        iframe {
            width: 200px;
        }

        .quiz-question {
            margin-bottom: 20px;
        }

        .show-answer-btn {
            margin-top: 10px;
        }

        .answer-text {
            margin-top: 10px;
            font-style: italic;
        }
        
        .n {
            border: solid;
            background-color: var(--primary-color);
            color: white;
            padding: 9px;
            border-radius: 5px;
            border-width: 0px;
        }

        .message, .error {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }

        .message {
            background-color: #4CAF50;
        }

        .error {
            background-color: #f44336;
        }

        .resource-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .resource-item .title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .resource-item .content {
            margin-top: 10px;
        }

        .note-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .note-item:hover {
            background-color: #f0f0f0;
        }

        .note-title {
            font-weight: bold;
        }

        .note-date {
            font-size: 0.8em;
            color: #666;
        }

        #note-editor {
            display: none;
        }

        #progress-container {
            margin-top: 20px;
        }

        #progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-fill {
            width: 0;
            height: 20px;
            background-color: var(--primary-color);
            transition: width 0.5s ease-in-out;
        }

        #progress-percentage {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        #saved-notes-container {
            margin-top: 20px;
        }

        .saved-note {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .saved-note h3 {
            margin-top: 0;
        }

        .saved-note p {
            margin-bottom: 0;
        }

        #lecture-recorder {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #transcription {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            resize: vertical;
        }

        .download-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .download-options select {
            padding: 5px;
        }

        .audio-note {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .audio-note audio {
            max-width: 200px;
        }

        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #chat-container {
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        #chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .user-message, .ai-message {
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            max-width: 80%;
        }

        .user-message {
            background-color: #e6f2ff;
            align-self: flex-end;
            margin-left: auto;
        }

        .ai-message {
            background-color: #f0f0f0;
            align-self: flex-start;
        }

        #user-input {
            width: calc(100% - 120px);
            padding: 10px;
            border: none;
            border-top: 1px solid #ddd;
        }

        #send-btn, #voice-input-btn {
            width: 60px;
            padding: 10px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
        }

        #voice-input-btn {
            background-color: var(--secondary-color);
        }

        .quiz-question {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
        }

        .quiz-option {
            margin: 5px 0;
        }

        #quiz-timer {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #submit-quiz {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
        }

        #quiz-result {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
	.vid{
	    width: 610px;
	    height: 300px;
	}

        .symbol {
            cursor: pointer;
            padding: 5px;
            margin: 5px;
            border: 1px solid #ccc;
            display: inline-block;
        }
        .symbol:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="loading-indicator">
        <div class="spinner"></div>
    </div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="#search-tab"><i class="fas fa-search"></i> Search</a>
        <a href="#library-tab"><i class="fas fa-book"></i> Library</a>
        <a href="#notes-tab"><i class="fas fa-sticky-note"></i> Notes</a>
        <a href="#quiz-tab"><i class="fas fa-question-circle"></i> Quiz</a>
        <a href="#flashcards-tab"><i class="fas fa-clone"></i> Flashcards</a>
        <a href="#progress-tab"><i class="fas fa-chart-line"></i> Progress</a>
        <a href="#lecture-recorder-tab"><i class="fas fa-microphone"></i> Audio Notes</a>
        <a href="#ai-tutor-tab"><i class="fas fa-robot"></i> AI Tutor</a>
    </div>
    
    <div id="main">
        <div class="header">
            <button class="openbtn" onclick="openNav()">&#9776; Menu</button>
            <h1><span class="highlight">Study</span>Mate</h1> 
            <nav>
                <a href="about.html" class="n">üë®‚Äçüè´About</a>
                <button id="theme-toggle" style="padding:13px;"><i class="fas fa-moon"></i></button>
                <div id="user-button"></div>
                <button id="sign-out-btn" style="display: none;">Sign Out</button>
            </nav>
        </div>

        <div id="app"></div>

        <section id="search-tab" class="tab-content active">
            <h2>Search for Study Materials</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Enter your search query" style="width:350px;">
                <button id="search-btn">Search</button>
            </div>
            <div id="search-results" class="results-container">
                <!-- Search results will be dynamically populated here -->
            </div>
<section id="upload-resource-tab" class="tab-content">
    <h2>Upload a New Resource</h2>
    <div>
        <label for="resource-title">Resource Title:</label>
        <input type="text" id="resource-title" placeholder="Enter resource title">
    </div>
    <div>
        <label for="resource-file">Select File:</label>
        <input type="file" id="resource-file" accept=".pdf,.docx,.txt,.pptx">
    </div>
    <button id="upload-resource-btn">Upload Resource</button>
</section>

        </section>

        <section id="library-tab" class="tab-content">
            <h2>Your Study Library</h2>
            <div class="search-container">
                <input type="text" id="library-search" placeholder="Search your library">
            </div>
            <div id="resource-list" class="results-container">
                <!-- Library resources will be dynamically populated here -->
            </div>
        </section>

        <section id="notes-tab" class="tab-content">
            <h2>Study Notes</h2>
            <div id="notes-container">
                <div id="note-list" class="note-list">
                    <!-- Note list will be dynamically populated here -->
                </div>
                <button id="new-note-btn">New Note</button>
                <div id="note-editor">
                    <input type="text" id="note-title" placeholder="Note Title">
                    <textarea id="note-content" rows="10" placeholder="Type your notes here..."></textarea>
                    <button id="save-note-btn">Save Note</button>
                </div>
                <div id="saved-notes-container">
                    <h3>Saved Notes</h3>
                    <!-- Saved notes will be dynamically populated here -->
                </div>
            </div>
        </section>

 <section id="quiz-tab" class="tab-content">
        <h2>Quiz</h2>
        <div id="quiz-container">
            <select id="quiz-resource-select">
                <!-- Options will be dynamically populated -->
            </select>
            <button id="generate-quiz">Generate Quiz</button>
            <div id="quiz-timer"></div>
            <div id="quiz-questions">
                <!-- Quiz questions will be dynamically populated here -->
            </div>
            <button id="submit-quiz" style="display: none;">Submit Quiz</button>
            <div id="quiz-result"></div>
        </div>
    </section>


        <section id="flashcards-tab" class="tab-content">
            <h2>Flashcards</h2>
            <div class="flashcard">
                <div class="flashcard-inner">
                    <div class="flashcard-front">
                        <p id="flashcard-question"></p>
                    </div>
                    <div class="flashcard-back">
                        <p id="flashcard-answer"></p>
                    </div>
                </div>
            </div>
            <button id="next-flashcard">Next Flashcard</button>
        </section>

        <section id="progress-tab" class="tab-content">
            <h2>Your Study Progress</h2>
            <div id="progress-container">
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <div id="progress-percentage">0% Complete</div>
            </div>
        </section>

        <section id="lecture-recorder-tab" class="tab-content">
            <h2>Lecture Recorder</h2>
            <div id="lecture-recorder">
                <button id="record-btn">Start Recording</button>
                <p id="recording-status"></p>
                <input type="text" id="audio-note-title" placeholder="Audio Note Title">
                <button id="save-audio-note-btn" style="display: none;">Save Audio Note</button>
            </div>
        </section>
<section>
<h1>Math</h1>
<div id="math-tools">
    <div id="math-solver">
        <h2>Math Solver</h2>
        <input type="text" id="math-input" placeholder="Enter your math expression" style="width: 350px;">
        <button onclick="solveMath()">Solve</button>
        <div id="math-result"></div>
    </div>

<div id="equation-solver">
    <h2>Equation Solver</h2>
    <input type="text" id="equation-input" placeholder="Enter equation, e.g., 64/d = 16" style="width: 350px;">
    <button onclick="solveEquation()">Solve Equation</button>
    <div id="equation-result"></div>
    <div id="working-steps"></div>
</div>

<!-- Scientific Calculator -->
<div id="scientific-calculator" style="margin-top: 20px;">
    <h2>Scientific Equation Calculator</h2>
    <input type="text" id="scientific-input" placeholder="Enter scientific expression" style="width: 350px;">
    <button onclick="calculateScientific()">Calculate</button>
    <div id="scientific-result"></div>
</div>

<!-- Equation Symbols -->
<div id="equation-symbols" style="margin-top: 20px;">
    <h2>Common Scientific Symbols</h2>
    <div>
        <span class="symbol" onclick="insertSymbol('+')">+</span>
        <span class="symbol" onclick="insertSymbol('-')">-</span>
        <span class="symbol" onclick="insertSymbol('*')">*</span>
        <span class="symbol" onclick="insertSymbol('/')">/</span>
        <span class="symbol" onclick="insertSymbol('=')">=</span>
        <span class="symbol" onclick="insertSymbol('^')">^</span>
        <span class="symbol" onclick="insertSymbol('sqrt(')">‚àö</span>
        <span class="symbol" onclick="insertSymbol('sin(')">sin</span>
        <span class="symbol" onclick="insertSymbol('cos(')">cos</span>
        <span class="symbol" onclick="insertSymbol('tan(')">tan</span>
        <span class="symbol" onclick="insertSymbol('log(')">log</span>
        <span class="symbol" onclick="insertSymbol('pi')">œÄ</span>
        <span class="symbol" onclick="insertSymbol('e')">e</span>
    </div>
</div>

</div>

</section>

        <section id="ai-tutor-tab" class="tab-content">
            <h2>AI Tutor</h2>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <input type="text" id="user-input" placeholder="Ask your question...">
                <button id="send-btn">Send</button>
                <button id="voice-input-btn">Voice Input</button>
<p>Under construction</p>
            </div>
        </section>
    </div>

    <script>
        // Constants
        const YOUTUBE_API_KEY = 'AIzaSyB2rnHY9f3tHESaJ1Bgm_3r_CsuhvtB794';
        const WIT_AI_TOKEN = 'P7GHGH7DBHJDCDQEV36YLS2LIW6NKMPU'; // Replace with your actual Wit.ai token
        const DB_NAME = 'StudyMateDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'resources';
        const NOTES_STORE_NAME = 'notes';
        const PROGRESS_STORE_NAME = 'progress';

        // DOM Elements
        const searchBtn = document.getElementById('search-btn');
        const librarySearchInput = document.getElementById('library-search');
        const darkModeToggle = document.getElementById('theme-toggle');
        const searchInput = document.getElementById('search-input');
        const searchResultsDiv = document.getElementById('search-results');
        const resourceListDiv = document.getElementById('resource-list');
        const newNoteBtn = document.getElementById('new-note-btn');
        const noteEditor = document.getElementById('note-editor');
        const noteTitleInput = document.getElementById('note-title');
        const noteContentInput = document.getElementById('note-content');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const noteListDiv = document.getElementById('note-list');
        const savedNotesContainer = document.getElementById('saved-notes-container');
        const generateQuizBtn = document.getElementById('generate-quiz');
        const quizQuestionsDiv = document.getElementById('quiz-questions');
        const nextFlashcardBtn = document.getElementById('next-flashcard');
        const quizResourceSelect = document.getElementById('quiz-resource-select');
        const progressFill = document.getElementById('progress-fill');
        const progressPercentage = document.getElementById('progress-percentage');
        const recordBtn = document.getElementById('record-btn');
        const recordingStatus = document.getElementById('recording-status');
        const audioNoteTitleInput = document.getElementById('audio-note-title');
        const saveAudioNoteBtn = document.getElementById('save-audio-note-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const chatMessages = document.getElementById('chat-messages');

        let db;
        let currentFlashcardIndex = 0;
        let flashcards = [];
        let activeNoteId = null;
        let mediaRecorder;
        let audioChunks = [];

        // Event Listeners
        window.addEventListener('load', async function () {
            showLoading();
            await Clerk.load({
                afterSignInUrl: window.location.href,
                afterSignUpUrl: window.location.href,
            });
            initializeApp();
        });

        searchBtn.addEventListener('click', handleSearch);
        librarySearchInput.addEventListener('input', handleLibrarySearch);
        darkModeToggle.addEventListener('click', toggleDarkMode);
        generateQuizBtn.addEventListener('click', generateQuiz);
        nextFlashcardBtn.addEventListener('click', showNextFlashcard);
        newNoteBtn.addEventListener('click', showNoteEditor);
        saveNoteBtn.addEventListener('click', saveNote);
        recordBtn.addEventListener('click', toggleRecording);
        saveAudioNoteBtn.addEventListener('click', saveAudioNote);
        signOutBtn.addEventListener('click', handleSignOut);
        sendBtn.addEventListener('click', sendMessage);
        voiceInputBtn.addEventListener('click', startVoiceInput);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Functions
        function showLoading() {
            loadingIndicator.style.display = 'flex';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        async function initializeApp() {
            const user = await Clerk.user;
            if (user) {
                document.getElementById('app').innerHTML = `
                    <div id="authenticated-content">
                        <!-- Your existing app content is already in the HTML structure -->
                    </div>
                `;
                const userButtonDiv = document.getElementById('user-button');
                await Clerk.mountUserButton(userButtonDiv);
                signOutBtn.style.display = 'inline-block';
                initDB();
                loadDarkModePreference();
                showContent();
            } else {
                document.getElementById('app').innerHTML = `
                    <div id="sign-in"></div>
                `;
                const signInDiv = document.getElementById('sign-in');
                await Clerk.mountSignIn(signInDiv);
                hideContent();
            }
            hideLoading();
        }

        function showContent() {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'block');
            document.querySelector('.sidebar').style.display = 'block';
        }

        function hideContent() {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelector('.sidebar').style.display = 'none';
        }

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => console.error("IndexedDB error:", event.target.error);
            request.onsuccess = (event) => {
                db = event.target.result;
                updateResourceList();
                updateQuizResourceSelect();
                generateFlashcards();
                loadNotes();
                loadProgress();
            };
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains(NOTES_STORE_NAME)) {
                    db.createObjectStore(NOTES_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains(PROGRESS_STORE_NAME)) {
                    db.createObjectStore(PROGRESS_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
            };
        }
document.getElementById('upload-resource-btn').addEventListener('click', function () {
    const title = document.getElementById('resource-title').value.trim();
    const fileInput = document.getElementById('resource-file');
    const file = fileInput.files[0];

    if (!title) {
        displayError('Please enter a title for the resource.');
        return;
    }

    if (!file) {
        displayError('Please select a file to upload.');
        return;
    }

    const reader = new FileReader();

    reader.onload = function (event) {
        const fileContent = event.target.result;
        const fileType = file.type;

        if (fileType === 'application/pdf') {
            extractTextFromPDF(fileContent, title);
        } else if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
            extractTextFromDocx(fileContent, title);
        } else {
            displayError('Unsupported file format.');
        }
    };

    reader.readAsArrayBuffer(file); // Read file as an ArrayBuffer for better binary support
});

function extractTextFromPDF(fileContent, title) {
    const pdfData = new Uint8Array(fileContent);
    pdfjsLib.getDocument(pdfData).promise.then(function (pdf) {
        const numPages = pdf.numPages;
        let text = '';

        for (let i = 1; i <= numPages; i++) {
            pdf.getPage(i).then(function (page) {
                page.getTextContent().then(function (textContent) {
                    textContent.items.forEach(item => {
                        text += item.str + ' ';
                    });

                    if (i === numPages) {
                        // After extracting all pages, save to IndexedDB
                        saveResourceToDB(title, text, 'text');
                    }
                });
            });
        }
    });
}

function extractTextFromDocx(fileContent, title) {
    mammoth.extractRawText({ arrayBuffer: fileContent })
        .then(function (result) {
            const text = result.value; // Extracted text from DOCX
            saveResourceToDB(title, text, 'text'); // Save to IndexedDB
        })
        .catch(function (err) {
            displayError('Failed to extract content from DOCX.');
            console.error(err);
        });
}

function saveResourceToDB(title, content, type) {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const resource = { title, content, type };
    const request = store.add(resource);

    request.onsuccess = () => {
        displayMessage('Resource uploaded and content extracted successfully.');
        updateResourceList(); // Update the library with the new resource
    };

    request.onerror = () => {
        displayError('Failed to upload resource.');
    };
}

function displayResourceList(resources) {
    resourceListDiv.innerHTML = ''; // Clear previous entries

    if (resources.length === 0) {
        resourceListDiv.innerHTML = '<p>No resources found.</p>';
        return;
    }

    resources.forEach((resource) => {
        const resourceItem = document.createElement('div');
        resourceItem.classList.add('resource-item');

        let contentDisplay;

        if (resource.type === 'video') {
            // Handle video resources
            contentDisplay = `
                <video width="560" height="315" id="video-${resource.id}" style="display: block; margin: auto;" preload="metadata">
                    <source src="${resource.content}" type="${resource.fileType}">
                    Your browser does not support the video tag.
                </video>
                <button class="play-btn" onclick="playVideo('video-${resource.id}')">Play</button>
                <button class="pause-btn" onclick="pauseVideo('video-${resource.id}')">Pause</button>
            `;
        } else {
            // Format text resources
            const formattedContent = formatTextResource(resource.content);
            contentDisplay = formattedContent;
        }

        resourceItem.innerHTML = `
            <div class="title">${resource.title}</div>
            <button class="toggle-btn">Show More</button>
            <button class="remove-btn">Remove</button>
            <div class="content" style="display: none;">
                ${contentDisplay}
            </div>
        `;

        // Toggle button logic
        resourceItem.querySelector('.toggle-btn').addEventListener('click', () => {
            const content = resourceItem.querySelector('.content');
            const toggleBtn = resourceItem.querySelector('.toggle-btn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleBtn.textContent = 'Show Less';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = 'Show More';
            }
        });

        // Remove button logic
        resourceItem.querySelector('.remove-btn').addEventListener('click', () => {
            removeResource(resource.id);
        });

        resourceListDiv.appendChild(resourceItem);
    });
}

    function solveMath() {
        const mathInput = document.getElementById('math-input').value;
        const mathResultDiv = document.getElementById('math-result');

        try {
            // Evaluate the input using Math.js
            const result = math.evaluate(mathInput);
            mathResultDiv.innerHTML = `<strong>Result:</strong> ${result}`;
        } catch (error) {
            // Handle any errors in case of invalid input
            mathResultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
    }

    function solveEquation() {
        const equationInput = document.getElementById('equation-input').value;
        const equationResultDiv = document.getElementById('equation-result');
        const workingStepsDiv = document.getElementById('working-steps');
        workingStepsDiv.innerHTML = ''; // Clear previous working steps

        try {
            // Split the equation into left and right parts by '='
            const sides = equationInput.split('=');
            if (sides.length !== 2) {
                throw new Error("Invalid equation format. Use '=' to separate left and right sides.");
            }

            // Extract the variable automatically
            const variableMatch = equationInput.match(/[a-zA-Z]/);  // Match any letter (variable)
            const variable = variableMatch ? variableMatch[0] : 'x'; // Default to 'x' if none found

            // Parse the left-hand side (LHS) and right-hand side (RHS)
            let lhs = algebra.parse(sides[0].trim());
            const rhs = algebra.parse(sides[1].trim());

            // Display the original equation
            workingStepsDiv.innerHTML += `<strong>Original Equation:</strong> ${lhs} = ${rhs}<br>`;

            // If division is present, multiply both sides by the variable to eliminate division
            if (lhs.toString().includes(`/${variable}`)) {
                workingStepsDiv.innerHTML += `Step 1: Multiply both sides by ${variable}<br>`;
                lhs = lhs.multiply(variable);
                const newRHS = rhs.multiply(variable);
                workingStepsDiv.innerHTML += `New Equation: ${lhs} = ${newRHS}<br>`;
            }

            // Rearranging the equation
            workingStepsDiv.innerHTML += `Step 2: Rearranging the equation to isolate ${variable}<br>`;
            const eq = new algebra.Equation(lhs, rhs);
            const steps = eq.toString();  // Get a string representation of the equation
            workingStepsDiv.innerHTML += `Equation before solving: ${steps}<br>`;

            // Solve the equation for the detected variable
            const solution = eq.solveFor(variable);

            workingStepsDiv.innerHTML += `<strong>Final Solution for ${variable}:</strong> ${solution.toString()}<br>`;
        } catch (error) {
            equationResultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
    }

function calculateScientific() {
        const scientificInput = document.getElementById('scientific-input').value;
        const scientificResultDiv = document.getElementById('scientific-result');

        try {
            // Evaluate the scientific expression using Math.js
            const result = math.evaluate(scientificInput);
            scientificResultDiv.innerHTML = `<strong>Result:</strong> ${result}`;
        } catch (error) {
            scientificResultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
    }

    function insertSymbol(symbol) {
        const scientificInput = document.getElementById('scientific-input');
        scientificInput.value += symbol; // Add the clicked symbol to the input
        scientificInput.focus(); // Bring focus back to the input field
    }

        async function handleSearch() {
            const query = searchInput.value;
            if (query) {
                showLoading();
                try {
                    const results = await fetchCombinedResults(query);
                    displayCombinedResults(results);
                } catch (error) {
                    displayError('An error occurred while fetching results. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        }

        async function fetchCombinedResults(query) {
            const wikiResults = await fetchWikipediaResults(query);
            const videoResults = await fetchYouTubeResults(query);
            return { wikiResults, videoResults };
        }

        async function fetchWikipediaResults(query) {
            const response = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${query}&format=json&origin=*`);
            const data = await response.json();
            return data.query.search;
        }

        async function fetchYouTubeResults(query) {
            const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=10&q=${query} Crash Course&key=${YOUTUBE_API_KEY}`);
            const data = await response.json();
            return data.items.map(item => ({
                title: item.snippet.title,
                url: `https://www.youtube.com/embed/${item.id.videoId}`
            }));
        }

        function displayCombinedResults({ wikiResults, videoResults }) {
            searchResultsDiv.innerHTML = '';

            if (wikiResults.length === 0 && videoResults.length === 0) {
                searchResultsDiv.innerHTML = '<p>No results found.</p>';
                return;
            }

            wikiResults.forEach(result => {
                const resultItem = createResultItem(result.title, result.snippet, () => saveResource(result.title, result.pageid));
                searchResultsDiv.appendChild(resultItem);
            });

            videoResults.forEach(result => {
                const resultItem = createVideoResultItem(result.title, result.url);
                searchResultsDiv.appendChild(resultItem);
            });
        }

        function createResultItem(title, snippet, saveFunction) {
            const resultItem = document.createElement('div');
            resultItem.classList.add('result-item');
            resultItem.innerHTML = `
                <h3>${title}</h3>
                <p>${snippet}...</p>
                <button class="save-btn">Add to Library</button>
            `;
            resultItem.querySelector('.save-btn').addEventListener('click', saveFunction);
            return resultItem;
        }

        function createVideoResultItem(title, url) {
            const resultItem = document.createElement('div');
            resultItem.classList.add('result-item');
            resultItem.innerHTML = `
                <h3>${title}</h3>
                <iframe class="video-player" src="${url}" frameborder="0" allowfullscreen></iframe>
                <button class="save-btn">Add to Library</button>
            `;
            resultItem.querySelector('.save-btn').addEventListener('click', () => saveCrashCourseVideo(title, url));
            return resultItem;
        }

        function handleLibrarySearch() {
            const searchQuery = librarySearchInput.value.toLowerCase();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = (event) => {
                const resources = event.target.result;
                const filteredResources = resources.filter(resource => 
                    resource.title.toLowerCase().includes(searchQuery)
                );
                displayResourceList(filteredResources);
            };

            request.onerror = (event) => {
                console.error("Error searching library:", event.target.error);
            };
        }

        function displayResourceList(filteredResources) {
            resourceListDiv.innerHTML = '';

            if (filteredResources.length === 0) {
                resourceListDiv.innerHTML = '<p>No resources found.</p>';
                return;
            }

            filteredResources.forEach((resource) => {
                const resourceItem = createResourceItem(resource);
                resourceListDiv.appendChild(resourceItem);
            });
        }

        function createResourceItem(resource) {
            const resourceItem = document.createElement('div');
            resourceItem.classList.add('resource-item');
            resourceItem.innerHTML = `
                <div class="title">${resource.title}</div>
                <button class="toggle-btn">Show More</button>
                <button class="remove-btn">Remove</button>
                <div class="content" style="display: none;">
                    ${resource.content}
                </div>
                <div class="download-options">
                    <select class="format-select">
                        <option value="pdf">PDF</option>
                        <option value="docx">Word (DOCX)</option>
                    </select>
                    <button class="download-btn">Download</button>
                </div>
            `;
            
            resourceItem.querySelector('.toggle-btn').addEventListener('click', () => {
                const content = resourceItem.querySelector('.content');
                const toggleBtn = resourceItem.querySelector('.toggle-btn');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggleBtn.textContent = 'Show Less';
                } else {
                    content.style.display = 'none';
                    toggleBtn.textContent = 'Show More';
                }
            });

            resourceItem.querySelector('.remove-btn').addEventListener('click', () => {
                removeResource(resource.id);
            });

            resourceItem.querySelector('.download-btn').addEventListener('click', () => {
                const format = resourceItem.querySelector('.format-select').value;
                downloadResource(resource, format);
            });

            return resourceItem;
        }

function saveResource(title, pageId) {
    showLoading();
    fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&format=json&pageids=${pageId}&origin=*`)
        .then(response => response.json())
        .then(data => {
            const page = data.query.pages[pageId];
            const content = page.extract; // This will give the full extract
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const resource = { title, content, type: 'wikipedia' };
            const request = store.add(resource);
            request.onsuccess = () => {
                displayMessage('Resource added to library');
                updateResourceList();
                updateQuizResourceSelect();
            };
            request.onerror = () => displayError('Failed to add resource to library');
        })
        .catch(() => displayError('Failed to fetch resource content'))
        .finally(() => hideLoading());
}


        function saveCrashCourseVideo(title, url) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const resource = {
                title: title,
                content: `<iframe src="${url}" frameborder="0" allowfullscreen class="vid"></iframe>`,
                type: 'video'
            };
            const request = store.add(resource);
            request.onsuccess = () => {
                displayMessage('Video added to library');
                updateResourceList();
                updateQuizResourceSelect();
            };
            request.onerror = () => displayError('Failed to add video to library');
        }

        function removeResource(id) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.delete(id);
            request.onsuccess = () => {
                displayMessage('Resource removed from library');
                updateResourceList();
                updateQuizResourceSelect();
            };
            request.onerror = () => displayError('Failed to remove resource from library');
        }

        function updateResourceList() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => {
                const resources = event.target.result;
                displayResourceList(resources);
            };
        }

        function updateQuizResourceSelect() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => {
                const resources = event.target.result;
                quizResourceSelect.innerHTML = '';
                resources.forEach((resource) => {
                    const option = document.createElement('option');
                    option.value = resource.id;
                    option.textContent = resource.title;
                    quizResourceSelect.appendChild(option);
                });
            };
        }

        function downloadResource(resource, format) {
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(resource.title, 10, 10);
                doc.text(resource.content, 10, 20);
                doc.save(`${resource.title}.pdf`);
            } else if (format === 'docx') {
                const { Document, Packer, Paragraph, TextRun } = docx;
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: resource.title,
                                        bold: true,
                                    }),
                                ],
                            }),
                            new Paragraph({
                                children: [
                                    new TextRun(resource.content),
                                ],
                            }),
                        ],
                    }],
                });

                Packer.toBlob(doc).then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    document.body.appendChild(a);
                    a.style = 'display: none';
                    a.href = url;
                    a.download = `${resource.title}.docx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        function loadDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function showNoteEditor() {
            noteEditor.style.display = 'block';
            noteTitleInput.value = '';
            noteContentInput.value = '';
            activeNoteId = null;
        }

        function saveNote() {
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();
            if (title && content) {
                const transaction = db.transaction([NOTES_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(NOTES_STORE_NAME);
                const note = {
                    title,
                    content,
                    date: new Date().toISOString(),
                    id: activeNoteId
                };
                let request;
                if (activeNoteId === null) {
                    request = store.add(note);
                } else {
                    request = store.put(note);
                }
                request.onsuccess = () => {
                    displayMessage('Note saved successfully');
                    noteEditor.style.display = 'none';
                    loadNotes();
                };
                request.onerror = () => displayError('Failed to save note');
            } else {
                displayError('Please enter both title and content for the note');
            }
        }

        function loadNotes() {
            const transaction = db.transaction([NOTES_STORE_NAME], 'readonly');
            const store = transaction.objectStore(NOTES_STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => {
                const notes = event.target.result;
                displayNotes(notes);
            };
        }

        function displayNotes(notes) {
            noteListDiv.innerHTML = '';
            savedNotesContainer.innerHTML = '<h3>Saved Notes</h3>';
            notes.forEach((note) => {
                const noteItem = document.createElement('div');
                noteItem.classList.add('note-item');
                noteItem.innerHTML = `
                    <span class="note-title">${note.title}</span>
                    <span class="note-date">${new Date(note.date).toLocaleString()}</span>
                    <button class="edit-note-btn">Edit</button>
                    <button class="delete-note-btn">Delete</button>
                `;
                noteItem.querySelector('.edit-note-btn').addEventListener('click', () => editNote(note));
                noteItem.querySelector('.delete-note-btn').addEventListener('click', () => deleteNote(note.id));
                noteListDiv.appendChild(noteItem);

                const savedNote = document.createElement('div');
                savedNote.classList.add('saved-note');
                savedNote.innerHTML = `
                    <h3>${note.title}</h3>
                    <p>${note.content}</p>
                `;
                savedNotesContainer.appendChild(savedNote);
            });
        }

        function editNote(note) {
            noteEditor.style.display = 'block';
            noteTitleInput.value = note.title;
            noteContentInput.value = note.content;
            activeNoteId = note.id;
        }

        function deleteNote(id) {
            const transaction = db.transaction([NOTES_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(NOTES_STORE_NAME);
            const request = store.delete(id);
            request.onsuccess = () => {
                displayMessage('Note deleted successfully');
                loadNotes();
            };
            request.onerror = () => displayError('Failed to delete note');
        }

        // Quiz-related variables
        let quizQuestions = [];
        let quizTimerId;

        // Updated quiz-related functions
function generateQuiz() {
    const selectedResourceId = quizResourceSelect.value;
    if (selectedResourceId) {
 // Close all resources
        const allResourceContent = document.querySelectorAll('.content');
        allResourceContent.forEach(content => content.style.display = 'none');

        // Disable all "Show More" buttons
        const allToggleButtons = document.querySelectorAll('.toggle-btn');
        allToggleButtons.forEach(button => button.disabled = true);

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(parseInt(selectedResourceId));
        request.onsuccess = (event) => {
            const resource = event.target.result;
            if (resource) {
                // Check the resource type and exclude video type
                if (resource.type !== 'video') {
                    quizQuestions = generateQuestionsFromContent(resource.content);
                    displayQuizQuestions(quizQuestions);
                    startQuizTimer();
                    document.getElementById('submit-quiz').style.display = 'block';
                } else {
                    displayError('Selected resource is a video and cannot be used for quiz generation.');
                }
            }
        };
    } else {
        displayError('Please select a resource for the quiz');
    }
}


        function generateQuestionsFromContent(content) {
            const sentences = content.split(/[.!?]+/);
            const questions = [];
            for (let i = 0; i < Math.min(30, sentences.length); i++) {
                const sentence = sentences[i].trim();
                if (sentence.length > 10) {
                    const words = sentence.split(' ');
                    const blankIndex = Math.floor(Math.random() * words.length);
                    const correctAnswer = words[blankIndex];
                    words[blankIndex] = '_____';
                    const question = words.join(' ');
                    
                    // Generate incorrect options
                    const incorrectOptions = generateIncorrectOptions(sentences, correctAnswer);
                    const options = [correctAnswer, ...incorrectOptions];
                    shuffleArray(options);

                    questions.push({ question, options, correctAnswer });
                }
            }
            return questions;
        }

        function generateIncorrectOptions(sentences, correctAnswer) {
            const allWords = sentences.join(' ').split(' ');
            const uniqueWords = [...new Set(allWords)];
            const incorrectOptions = [];
            while (incorrectOptions.length < 3) {
                const randomWord = uniqueWords[Math.floor(Math.random() * uniqueWords.length)];
                if (randomWord !== correctAnswer && !incorrectOptions.includes(randomWord)) {
                    incorrectOptions.push(randomWord);
                }
            }
            return incorrectOptions;
        }

        function displayQuizQuestions(questions) {
            quizQuestionsDiv.innerHTML = '';
            questions.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.classList.add('quiz-question');
                questionElement.innerHTML = `
                    <p><strong>Question ${index + 1}:</strong> ${q.question}</p>
                    <div class="quiz-options">
                        ${q.options.map((option, i) => `
                            <label class="quiz-option">
                                <input type="radio" name="q${index}" value="${option}">
                                ${option}
                            </label>
                        `).join('')}
                    </div>
                `;
                quizQuestionsDiv.appendChild(questionElement);
            });
        }

        function startQuizTimer() {
            let timeLeft = 600; // 3 minutes
            const timerElement = document.getElementById('quiz-timer');
            clearInterval(quizTimerId); // Clear any existing timer
            quizTimerId = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `Time left: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                if (timeLeft === 0) {
                    clearInterval(quizTimerId);
                    submitQuiz();
                }
                timeLeft--;
            }, 1000);
        }

function submitQuiz() {
    clearInterval(quizTimerId); // Stop the timer
    const quizQuestionElements = document.querySelectorAll('.quiz-question');
    let score = 0;
    quizQuestionElements.forEach((questionElement, index) => {
        const selectedOption = questionElement.querySelector('input[type="radio"]:checked');
        const resultElement = document.createElement('p'); // Create an element to display result
        
        if (selectedOption) {
            if (selectedOption.value === quizQuestions[index].correctAnswer) {
                score++;
                resultElement.textContent = "‚úîCorrect! Good Job";
                resultElement.style.color = "green";
            } else {
                resultElement.textContent = `‚ùåTry Again! The correct answer was: ${quizQuestions[index].correctAnswer}`;
                resultElement.style.color = "red";
            }
        } else {
            resultElement.textContent = `‚ùîNo answer selected. The correct answer was: ${quizQuestions[index].correctAnswer}`;
            resultElement.style.color = "orange";
        }
        
        questionElement.appendChild(resultElement); // Add result to the question element
    });
    
    const percentage = (score / quizQuestions.length) * 100;
    document.getElementById('quiz-result').textContent = `Your score: ${score}/${quizQuestions.length} (${percentage.toFixed(2)}%)`;
    document.getElementById('submit-quiz').style.display = 'none';

    // Re-enable all "Show More" buttons
    const allToggleButtons = document.querySelectorAll('.toggle-btn');
    allToggleButtons.forEach(button => button.disabled = false);
}


        // Event listeners
        generateQuizBtn.addEventListener('click', generateQuiz);
        document.getElementById('submit-quiz').addEventListener('click', submitQuiz);


        function generateFlashcards() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => {
                const resources = event.target.result;
                flashcards = [];
                resources.forEach((resource) => {
                    const sentences = resource.content.split(/[.!?]+/);
                    sentences.forEach((sentence) => {
                        if (sentence.trim().length > 10) {
                            flashcards.push({
                                question: sentence.trim(),
                                answer: resource.title
                            });
                        }
                    });
                });
                shuffleArray(flashcards);
                showNextFlashcard();
            };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showNextFlashcard() {
            if (flashcards.length > 0) {
                const flashcard = flashcards[currentFlashcardIndex];
                document.getElementById('flashcard-question').textContent = flashcard.question;
                document.getElementById('flashcard-answer').textContent = flashcard.answer;
                currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcards.length;
                document.querySelector('.flashcard').classList.remove('flipped');
            }
        }

        document.querySelector('.flashcard').addEventListener('click', function() {
            this.classList.toggle('flipped');
        });

        function loadProgress() {
            const transaction = db.transaction([PROGRESS_STORE_NAME], 'readonly');
            const store = transaction.objectStore(PROGRESS_STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => {
                const progressData = event.target.result;
                if (progressData.length > 0) {
                    updateProgressBar(progressData[0].progress);
                } else {
                    updateProgressBar(0);
                }
            };
        }

        function updateProgressBar(progress) {
            progressFill.style.width = `${progress}%`;
            progressPercentage.textContent = `${progress}% Complete`;
        }

        function saveProgress(progress) {
            const transaction = db.transaction([PROGRESS_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(PROGRESS_STORE_NAME);
            const request = store.put({ id: 1, progress });
            request.onsuccess = () => {
                updateProgressBar(progress);
            };
        }

        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.textContent = 'Start Recording';
                recordingStatus.textContent = 'Recording stopped';
                saveAudioNoteBtn.style.display = 'inline-block';
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        audioChunks = [];
                        mediaRecorder.addEventListener('dataavailable', event => {
                            audioChunks.push(event.data);
                        });
                        mediaRecorder.addEventListener('stop', () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audio = new Audio(audioUrl);
                            audio.controls = true;
                            document.body.appendChild(audio);
                        });
                        recordBtn.textContent = 'Stop Recording';
                        recordingStatus.textContent = 'Recording...';
                        saveAudioNoteBtn.style.display = 'none';
                    });
            }
        }

        function saveAudioNote() {
            const title = audioNoteTitleInput.value.trim();
            if (title && audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const transaction = db.transaction([NOTES_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(NOTES_STORE_NAME);
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = function() {
                    const base64data = reader.result;
                    const audioNote = {
                        title: title,
                        content: base64data,
                        type: 'audio',
                        date: new Date().toISOString()
                    };
                    const request = store.add(audioNote);
                    request.onsuccess = () => {
                        displayMessage('Audio note saved successfully');
                        audioNoteTitleInput.value = '';
                        saveAudioNoteBtn.style.display = 'none';
                        loadNotes();
                    };
                    request.onerror = () => displayError('Failed to save audio note');
                }
            } else {
                displayError('Please provide a title and record audio before saving');
            }
        }

        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.classList.add('message');
            document.body.appendChild(messageElement);
            setTimeout(() => {
                messageElement.remove();
            }, 3000);
        }

        function displayError(error) {
            const errorElement = document.createElement('div');
            errorElement.textContent = error;
            errorElement.classList.add('error');
            document.body.appendChild(errorElement);
            setTimeout(() => {
                errorElement.remove();
            }, 3000);
        }

        function openNav() {
            document.getElementById("mySidebar").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
        }

        async function handleSignOut() {
            await Clerk.signOut();
            window.location.reload();
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (message) {
                appendMessage('user', message);
                userInput.value = '';
                showLoading();
                try {
                    const response = await sendToWitAi(message);
                    const aiResponse = handleWitAiResponse(response);
                    appendMessage('ai', aiResponse);
                } catch (error) {
                    console.error('Error:', error);
                    appendMessage('ai', 'Sorry, I encountered an error. Please try again.');
                }
                hideLoading();
            }
        }

        function appendMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendToWitAi(message) {
            const response = await fetch('https://api.wit.ai/message?v=20230215', {
                headers: {
                    'Authorization': `Bearer ${WIT_AI_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                method: 'POST',
                body: JSON.stringify({ q: message }),
            });
            return await response.json();
        }

        function handleWitAiResponse(response) {
            // This is a basic implementation. You should expand this based on your Wit.ai app's capabilities.
            if (response.intents && response.intents.length > 0) {
                const intent = response.intents[0].name;
                switch (intent) {
                    case 'get_definition':
                        return generateDefinition(response.entities);
                    case 'generate_quiz':
                        return generateQuestionsFromWitAiResponse(response.entities);
                    // Add more cases for other intents
                    default:
                        return "I'm not sure how to help with that. Can you please rephrase your question?";
                }
            }
            return "I didn't understand that. Can you please rephrase your question?";
        }

        function generateDefinition(entities) {
            // This is a placeholder. In a real implementation, you would use a dictionary API or your own database.
            const term = entities['wit$search_query:search_query'][0].value;
            return `Here's a definition for ${term}: [Insert actual definition here]`;
        }

        function generateQuestionsFromWitAiResponse(entities) {
            // This is a placeholder. In a real implementation, you would generate questions based on the entities.
            return "Here are some quiz questions based on your request: [Insert generated questions here]";
        }

        function startVoiceInput() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    voiceInputBtn.textContent = 'Listening...';
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    voiceInputBtn.textContent = 'Voice Input';
                    sendMessage();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    voiceInputBtn.textContent = 'Voice Input';
                };

                recognition.onend = () => {
                    voiceInputBtn.textContent = 'Voice Input';
                };

                recognition.start();
            } else {
                alert('Speech recognition is not supported in your browser.');
            }
        }
    </script>
</body>
</html>